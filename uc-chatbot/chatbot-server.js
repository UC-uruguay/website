require('dotenv').config();

const express = require('express');
const cors = require('cors');
const fs = require('fs').promises;
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// Load knowledge base
let knowledgeBase;
async function loadKnowledgeBase() {
  const data = await fs.readFile(path.join(__dirname, 'uc-knowledge-base.json'), 'utf8');
  knowledgeBase = JSON.parse(data);
  console.log('Knowledge base loaded successfully');
}

// Initialize knowledge base
loadKnowledgeBase().catch(console.error);

// Anthropic Claude API integration
async function getChatResponse(userMessage, conversationHistory = []) {
  const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;

  if (!ANTHROPIC_API_KEY) {
    // Fallback to simple keyword-based responses if no API key
    return getKeywordBasedResponse(userMessage);
  }

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-3-opus-20240229',
        max_tokens: 400,
        system: `ã‚ãªãŸã¯UCï¼ˆä¸­å¶‹é›„å£«ï¼‰ã•ã‚“ã«ã¤ã„ã¦è³ªå•ã«ç­”ãˆã‚‹ã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚

UCã•ã‚“ã®æƒ…å ±:
${JSON.stringify(knowledgeBase, null, 2)}

UCã®SNSãƒªãƒ³ã‚¯:
- Instagram: https://www.instagram.com/toriaezu_uc
- X (Twitter): https://x.com/TORIAEZU_OU
- TikTok: https://www.tiktok.com/@ucjapan360
- YouTube: https://www.youtube.com/@Ichiyu.TheBoy

å›žç­”ãƒ«ãƒ¼ãƒ«ï¼š
1. **ç°¡æ½”ã«2-3æ–‡ã§å›žç­”**ï¼ˆé•·ãã¦ã‚‚4æ–‡ã¾ã§ï¼‰
2. **ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªå£èª¿**ã§å‹é”ã¨è©±ã™ã‚ˆã†ã«
3. **ã€Œã¨ã‚Šã‚ãˆãšã€ç²¾ç¥ž**ã‚’åæ˜ ã—ã¦ãƒã‚¸ãƒ†ã‚£ãƒ–ã«
4. **ã‚ã‹ã‚‰ãªã„æ™‚**ã¯SNSã§ç¢ºèªã™ã‚‹ã“ã¨ã‚’ææ¡ˆ

å£èª¿ã®ä¾‹:
âŒ ã€ŒUCã•ã‚“ã¯å±±æ¢¨çœŒã«ä½ã‚“ã§ã„ã¾ã™ã€
âœ… ã€Œå±±æ¢¨ã®ç”²åºœã«ä½ã‚“ã§ã‚‹ã‚ˆï¼å®¶æ—3äººã§æ¥½ã—ãæš®ã‚‰ã—ã¦ã‚‹ã€

å¿…ãšçŸ­ãç°¡æ½”ã«ç­”ãˆã¦ãã ã•ã„ã€‚`,
        messages: [
          ...conversationHistory,
          {
            role: 'user',
            content: userMessage
          }
        ]
      })
    });

    const data = await response.json();

    if (data.error) {
      console.error('Anthropic API Error:', data.error);
      return getKeywordBasedResponse(userMessage);
    }

    return data.content[0].text;
  } catch (error) {
    console.error('Error calling Anthropic API:', error);
    return getKeywordBasedResponse(userMessage);
  }
}

// Fallback keyword-based response system
function getKeywordBasedResponse(message) {
  const lowerMessage = message.toLowerCase();

  // Greeting
  if (lowerMessage.match(/ã“ã‚“ã«ã¡ã¯|ã¯ã˜ã‚ã¾ã—ã¦|hello|hi/)) {
    return `ã¯ã˜ã‚ã¾ã—ã¦ï¼åƒ•ã¯UCï¼ˆä¸­å¶‹é›„å£«ãƒ»ãªã‹ã—ã¾ã‚†ã†ã—ï¼‰ã«ã¤ã„ã¦ç­”ãˆã‚‹ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚UCã®ã“ã¨ã«ã¤ã„ã¦ä½•ã§ã‚‚èžã„ã¦ãã ã•ã„ï¼\n\nä¾‹ãˆã°ï¼š\n- UCã£ã¦èª°ã§ã™ã‹ï¼Ÿ\n- ã©ã‚“ãªä¼šç¤¾ã‚’çµŒå–¶ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ\n- ã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³ã«ã¤ã„ã¦æ•™ãˆã¦\n- å¥½ããªã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ`;
  }

  // About UC
  if (lowerMessage.match(/èª°|who|ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«|è‡ªå·±ç´¹ä»‹|å¹´é½¢|ä½•æ­³|age/)) {
    return `UCã¯ä¸­å¶‹é›„å£«ï¼ˆãªã‹ã—ã¾ã‚†ã†ã—ï¼‰ã•ã‚“ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã™ï¼1990å¹´8æœˆ12æ—¥ç”Ÿã¾ã‚Œã®35æ­³ã€ç¦å²¡çœŒå‡ºèº«ï¼ˆæ ƒæœ¨ç”Ÿã¾ã‚Œã€ç¦å²¡è‚²ã¡ï¼‰ã€‚ç¾åœ¨ã¯å±±æ¢¨çœŒç”²åºœå¸‚ã«å¦»ã®æ˜¥æ—¥ã•ã‚“ã¨æ¯å­ã®ä¸€éŠãã‚“ã¨æš®ã‚‰ã—ã¦ã„ã¾ã™ã€‚\n\nã‚¨ã‚¹ãƒˆãƒ‹ã‚¢ã¨ãƒ«ãƒ¯ãƒ³ãƒ€ã§ä¼šç¤¾ã‚’çµŒå–¶ã™ã‚‹èµ·æ¥­å®¶ã§ã€åº§å³ã®éŠ˜ã¯ã€Œã¨ã‚Šã‚ãˆãšã€ã€‚ã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³250kmã‚’èµ°ç ´ã—ãŸã‚Šã€34ã‚«å›½ã‚’æ—…ã—ãŸã‚Šã¨ã€è¶…ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªäººç”Ÿã‚’é€ã£ã¦ã„ã¾ã™ï¼\n\näººã¨äººã‚’ç¹‹ãã“ã¨ãŒå¤§å¥½ãã§ã€ã€Œäººç”Ÿã¯å‹é”ã®è³ªã¨é‡ã§æ±ºã¾ã‚‹ã€ã¨ã„ã†ã®ãŒå½¼ã®å“²å­¦ã§ã™ã€‚`;
  }

  // Companies
  if (lowerMessage.match(/ä¼šç¤¾|èµ·æ¥­|ãƒ“ã‚¸ãƒã‚¹|company|business/)) {
    return `UCã¯2ã¤ã®ä¼šç¤¾ã‚’çµŒå–¶ã—ã¦ã„ã¾ã™ï¼\n\n1ï¸âƒ£ **TORIAEZU OÃœ**ï¼ˆã‚¨ã‚¹ãƒˆãƒ‹ã‚¢ï¼‰\n- ITä¼æ¥­ãƒžãƒƒãƒãƒ³ã‚°\n- è¦–å¯Ÿè¨ªå•ä¼ç”»\n- ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬\n- çµŒå–¶ç†å¿µï¼š\"Empower your TORIAEZU mind\"\n\n2ï¸âƒ£ **Chant-through**ï¼ˆãƒ«ãƒ¯ãƒ³ãƒ€ï¼‰\n- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ™ãƒ“ãƒ¼ã‚·ãƒƒã‚¿ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹\n- æ—¥æœ¬7ç´™ã‚„ã‚¤ã‚®ãƒªã‚¹ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã‚‚å ±é“ã•ã‚Œã¾ã—ãŸï¼\n\nã©ã¡ã‚‰ã‚‚ã€Œã¨ã‚Šã‚ãˆãšã‚„ã£ã¦ã¿ã‚ˆã†ã€ç²¾ç¥žã‹ã‚‰ç”Ÿã¾ã‚ŒãŸä¼šç¤¾ã§ã™ã€‚`;
  }

  // Sahara Marathon
  if (lowerMessage.match(/ã‚µãƒãƒ©|ãƒžãƒ©ã‚½ãƒ³|sahara|marathon/)) {
    return `ã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³ã¯UCã®äººç”Ÿã‚’å¤‰ãˆãŸå¤§ããªå‡ºæ¥äº‹ã§ã™ï¼\n\nä¸–ç•Œä¸€éŽé…·ã¨è¨€ã‚ã‚Œã‚‹250kmã®ç ‚æ¼ ãƒžãƒ©ã‚½ãƒ³ã‚’22æ­³ã®æ™‚ã«èµ°ç ´ã—ã¾ã—ãŸã€‚ã“ã®ãƒžãƒ©ã‚½ãƒ³ã§ã€ŒãƒŽãƒ¼ã‚¿ã‚¤ãƒ ãƒãƒã€ï¼ˆç›´æ„Ÿã«å¾“ã£ã¦å³è¡Œå‹•ã™ã‚‹ï¼‰ã¨ã„ã†æ•™ãˆã«å‡ºä¼šã„ã€ãã‚ŒãŒUCã®ã€Œã¨ã‚Šã‚ãˆãšã€ç²¾ç¥žã®åŽŸç‚¹ã«ãªã‚Šã¾ã—ãŸã€‚\n\nã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³å¾Œã€UCã®åœ§å€’çš„ãƒŽãƒ¼ã‚¿ã‚¤ãƒ ãƒãƒäººç”ŸãŒå§‹ã¾ã£ãŸã‚“ã§ã™ï¼é¢ç™½ã„äººãŸã¡ã¨ã®å‡ºä¼šã„ã‚‚ãŸãã•ã‚“ã‚ã‚Šã€ä»Šã§ã‚‚ãã®ä»²é–“ãŸã¡ã¨äº¤æµãŒç¶šã„ã¦ã„ã¾ã™ã€‚`;
  }

  // Philosophy
  if (lowerMessage.match(/å“²å­¦|è€ƒãˆæ–¹|ã¨ã‚Šã‚ãˆãš|ç²¾ç¥ž|motto|philosophy/)) {
    return `UCã®äººç”Ÿå“²å­¦ã¯ã€Œã¨ã‚Šã‚ãˆãšã€ã§ã™ï¼\n\nâœ¨ **ã€Œã¨ã‚Šã‚ãˆãšã€ç²¾ç¥ž**\nç›´æ„Ÿã«å¾“ã£ã¦ã€1ç§’ã‚‚è€ƒãˆãšã«è¡Œå‹•ã™ã‚‹ã€‚æ‚©ã¾ãªã„ã®ã§æ™‚é–“ãŒå¢—ãˆã€è‡ªåˆ†ã«ã‚‚ä»–äººã«ã‚‚å„ªã—ããªã‚Œã‚‹ã€‚\n\nâœ¨ **ãƒŽãƒ¼ã‚¿ã‚¤ãƒ ãƒãƒ**\nã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³ã§å­¦ã‚“ã æ•™ãˆã€‚è¿·ã†å‰ã«å³è¡Œå‹•ï¼\n\nâœ¨ **äººç”Ÿã®ç›®æ¨™**\nã€Œå‹é”ã‚’æ²¢å±±ä½œã£ã¦æ¥½ã—ãç”Ÿãã‚‹ã€\näººç”Ÿã¯å‹é”ã®è³ªã¨é‡ã§æ±ºã¾ã‚‹ã¨ä¿¡ã˜ã¦ã„ã¾ã™ã€‚\n\nâœ¨ **å¼·ã¿**ï¼ˆStrengthFinderï¼‰\næˆ¦ç•¥æ€§ã€ç¤¾äº¤æ€§ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã€æœ€ä¸Šå¿—å‘ã€ç€æƒ³\n\nã“ã®è€ƒãˆæ–¹ã§ã€æµ·å¤–ç§»ä½ã€èµ·æ¥­ã€ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆç™»å±±ã€çµå©šã€å­è‚²ã¦ã¾ã§å…¨éƒ¨å®Ÿç¾ã—ã¾ã—ãŸï¼`;
  }

  // Achievements
  if (lowerMessage.match(/å®Ÿç¸¾|é”æˆ|achievement|accomplishment/)) {
    return `UCã®ä¸»ãªå®Ÿç¸¾ã‚’ã”ç´¹ä»‹ã—ã¾ã™ï¼\n\nðŸƒ ã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³250kmèµ°ç ´\nâ›°ï¸ ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã‚­ãƒ£ãƒ³ãƒ—ï¼ˆ5356mï¼‰ç™»é ‚\nðŸŒ 34ã‚«å›½è¨ªå•\nâ° ä¸–ç•Œ9æ‹ ç‚¹ã«ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã‚’åŸ‹ã‚ã‚‹\nðŸŽ‰ ä¾‹ã®ãƒ—ãƒ¼ãƒ«ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼é–‹å‚¬ï¼ˆ160äººå‚åŠ ï¼‰\nðŸ’° UCå°‘é¡å¥¨å­¦é‡‘8å¹´é–“é‹å–¶ï¼ˆçµ¦æ–™ã®8%ã‚’å¯„ä»˜ï¼‰\nðŸ—¾ 47éƒ½é“åºœçœŒ+1å›½ã‚’347æ—¥ã§é”æˆ\n\nã©ã‚Œã‚‚ã€Œã¨ã‚Šã‚ãˆãšã‚„ã£ã¦ã¿ã‚ˆã†ã€ã‹ã‚‰å§‹ã¾ã£ãŸã“ã¨ã°ã‹ã‚Šã§ã™ï¼`;
  }

  // Hobbies
  if (lowerMessage.match(/è¶£å‘³|å¥½ã|hobby|like|èˆˆå‘³/)) {
    return `UCã®è¶£å‘³ã¯ï¼š\n\nâ° **ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã‚’åŸ‹ã‚ã‚‹ã“ã¨**\nä¸–ç•Œ9æ‹ ç‚¹ã«åŸ‹ã‚ã¾ã—ãŸï¼å°å­¦æ ¡æ™‚ä»£ã®ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«æŽ¢ã—ãŒãƒ†ãƒ¬ãƒ“ã§æˆåŠŸã—ãŸæ€ã„å‡ºã‹ã‚‰å§‹ã¾ã£ãŸè¶£å‘³ã§ã™ã€‚\n\nðŸ‘¥ **å‹é”ä½œã‚Š**\næ¯Žæ—¥èª°ã‹ã¨ä¼šã£ã¦ã€æ–°ã—ã„å‡ºä¼šã„ã‚’æ¥½ã—ã‚“ã§ã„ã¾ã™ã€‚\n\nâœˆï¸ **æ—…è¡Œ**\n34ã‚«å›½è¨ªå•ã€ã‚¨ã‚¹ãƒˆãƒ‹ã‚¢ã€ãƒ«ãƒ¯ãƒ³ãƒ€ã€ã‚¦ãƒ«ã‚°ã‚¢ã‚¤ãªã©è¤‡æ•°ã®å›½ã§ç”Ÿæ´»çµŒé¨“ã‚ã‚Šã€‚\n\nðŸ‰ **ãƒ©ã‚°ãƒ“ãƒ¼**\né«˜æ ¡æ™‚ä»£ã«éƒ¨æ´»ã§ã€ä»Šã§ã‚‚åœ°å…ƒãƒãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹ã»ã©å¥½ãã€‚\n\nðŸ· **ãƒ¯ã‚¤ãƒ³**\nå±±æ¢¨åœ¨ä½ãªã®ã§ãƒ¯ã‚¤ãƒ³ã‚‚æ¥½ã—ã‚“ã§ã¾ã™ï¼`;
  }

  // Family
  if (lowerMessage.match(/å®¶æ—|å¦»|æ¯å­|å­ã©ã‚‚|family|wife|son|child/)) {
    return `UCã®å®¶æ—ã«ã¤ã„ã¦ï¼š\n\nðŸ‘¨â€ðŸ‘©â€ðŸ‘¦ **å®¶æ—æ§‹æˆ**\nå¦»ï¼šæ˜¥æ—¥ã•ã‚“\næ¯å­ï¼šä¸€éŠï¼ˆã‹ãšã‚†ï¼‰ãã‚“\n\nðŸ“ **ç¾åœ¨ã®ä½ã¾ã„**\nå±±æ¢¨çœŒç”²åºœå¸‚\n\nðŸ’¡ **å®¶æ—ã¨ã®è€ƒãˆæ–¹**\nã€Œå¼±ã„ç¹‹ãŒã‚Šã®å¼·ã¿ã€ã‚’ä¿¡ã˜ã¦ã„ã¦ã€å®¶æ—ã¨ã‚‚é©åº¦ãªè·é›¢ã‚’ä¿ã¤ã“ã¨ãŒå¤§äº‹ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚å­ã©ã‚‚ã«ã‚‚ã©ã‚“ã©ã‚“å¤–ã«å‡ºã¦æ–°ã—ã„å‹é”ã‚’ä½œã£ã¦ã»ã—ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚\n\nðŸ§ª **ä¸€éŠãã‚“ã§å®Ÿé¨“ä¸­**\næ¯å­ã®å£åº§ã‚’å…¬é–‹ã—ã¦ã€ãƒžãƒãƒ¼ãƒã‚¤ãƒ†ã‚£ãƒ–æ•™è‚²ã‚’å®Ÿé¨“ä¸­ï¼4æ­³ã‹ã‚‰è‡ªåˆ†ã§ãŠé‡‘ã‚’ç®¡ç†ã•ã›ã‚‹äºˆå®šã§ã™ã€‚`;
  }

  // Time Capsule
  if (lowerMessage.match(/ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«|time capsule/)) {
    return `ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã¯UCã®å¤§å¥½ããªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã™ï¼\n\nðŸ“¦ **ã“ã‚Œã¾ã§ã®å®Ÿç¸¾**\nä¸–ç•Œ9æ‹ ç‚¹ã«ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã‚’åŸ‹ã‚ã¾ã—ãŸã€‚\n\nðŸ’¡ **ãã£ã‹ã‘**\nå°å­¦æ ¡6å¹´ç”Ÿã®æ™‚ã«åŸ‹ã‚ãŸã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ãŒã€ä½•åº¦æŽ˜ã£ã¦ã‚‚è¦‹ã¤ã‹ã‚‰ãšã€æœ€çµ‚çš„ã«ãƒ†ãƒ¬ãƒ“ç•ªçµ„ã®åŠ›ã‚’å€Ÿã‚Šã¦é‡æ©Ÿã§ç™ºæŽ˜æˆåŠŸï¼ã“ã®çµŒé¨“ã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã«æƒšã‚Œè¾¼ã¿ã¾ã—ãŸã€‚\n\nâœ¨ **é­…åŠ›**\n- åŸ‹ã‚ã‚‹çž¬é–“ã«æœªæ¥ã‚’äºˆæƒ³ã—ã¦å¿ƒå¼¾ã¾ã›ã‚‹\n- é–‹ã‘ã‚‹æ™‚ã«ã¯è¨˜æ†¶åŠ›ã®ä½Žä¸‹ã«ã‚¬ãƒƒã‚«ãƒª\n- æŽ˜ã‚Šã¾ãã‚‹è‹¦åŠ´ã®å¾Œã®ãƒ¯ã‚¯ãƒ¯ã‚¯æ„Ÿï¼\n\nã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã‚’åŸ‹ã‚ãŸã„äººã€é€£çµ¡ãã ã•ã„ï¼ä¸€ç·’ã«åŸ‹ã‚ã¾ã—ã‚‡ã†ï¼`;
  }

  // Pool Party
  if (lowerMessage.match(/ãƒ—ãƒ¼ãƒ«|ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼|pool|party|ä¾‹ã®/)) {
    return `ã€Œä¾‹ã®ãƒ—ãƒ¼ãƒ«ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã€ã¯ä¼èª¬ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã™ï¼\n\nðŸŠ **æ¦‚è¦**\næ–°å®¿ã®ã€Œä¾‹ã®ãƒ—ãƒ¼ãƒ«ã€ï¼ˆã‚¢ãƒ€ãƒ«ãƒˆãƒ“ãƒ‡ã‚ªã§ãŠé¦´æŸ“ã¿ã®æ’®å½±ã‚¹ã‚¿ã‚¸ã‚ªï¼‰ã‚’22ä¸‡å††ã§è²¸ã—åˆ‡ã‚Šã€160äººãŒå‚åŠ ã™ã‚‹å¤§ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã‚’é–‹å‚¬ï¼\n\nðŸŽ‰ **ã‚³ãƒ³ãƒ†ãƒ³ãƒ„**\n- æ€§ç™–ãƒ“ãƒ³ã‚´ï¼ˆç‰¹è³žã¯ãƒ†ã‚£ãƒ•ã‚¡ãƒ‹ãƒ¼ã®ãƒãƒƒã‚¯ãƒ¬ã‚¹ï¼‰\n- ãƒ—ãƒ¼ãƒ«é¨Žé¦¬æˆ¦\n- æ’®å½±ä¼š\n- å®æŽ¢ã—\n- AVç›£ç£ã‚²ã‚¹ãƒˆå‡ºæ¼”\n\nðŸ“ˆ **çµæžœ**\nãƒãƒƒãƒˆã§å¤§æ‹¡æ•£ã€ãƒã‚±ãƒƒãƒˆå³å®Œå£²ï¼\n\nç¿Œå¹´ã‚‚é–‹å‚¬ã—ãŸã‘ã©ã€ãã®å¾Œã¿ã‚“ãªãŒçœŸä¼¼ã—å§‹ã‚ã¦å¤§æƒ¨æ•—...ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒšãƒ³ã‚®ãƒ³ã®è‰¯ã„ã¨ã“ã‚ã¨ãƒªã‚¹ã‚¯ã‚’ä½“é¨“ã—ã¾ã—ãŸï¼`;
  }

  // Scholarship
  if (lowerMessage.match(/å¥¨å­¦é‡‘|scholarship|å¯„ä»˜|donation/)) {
    return `**UCå°‘é¡å¥¨å­¦é‡‘**ã¯UCãŒ8å¹´é–“ç¶šã‘ã¦ã„ã‚‹å€‹äººå¥¨å­¦é‡‘åˆ¶åº¦ã§ã™ï¼\n\nðŸ’° **ä»•çµ„ã¿**\n- çµ¦æ–™ã®1%ã‚’ä»–äººã«ã‚ã’ã‚‹\n- æ¯Žå¹´1äººãšã¤å—çµ¦è€…ã‚’å¢—ã‚„ã™\n- ç¾åœ¨ã¯çµ¦æ–™ã®8%ã‚’å¯„ä»˜ä¸­\n\nðŸŽ¯ **ç›®çš„**\né¢ç™½ã„æ´»å‹•ã‚’ã—ã¦ã„ã‚‹äººã‚’å¿œæ´ã™ã‚‹ãŸã‚ã€‚å­¦ç”Ÿã ã‘ã§ãªãã€ç¤¾ä¼šäººã‚„éžå–¶åˆ©æ´»å‹•ã‚’ã—ã¦ã„ã‚‹äººã‚‚å¯¾è±¡ã€‚\n\nâœ¨ **å­¦ã³**\nã€Œé¸ã¶å´ã€ã‚’çµŒé¨“ã™ã‚‹ã“ã¨ã§ã€è‡ªåˆ†ãŒã€Œé¸ã°ã‚Œã‚‹å´ã€ã«ãªã£ãŸæ™‚ã®æŒ¯ã‚‹èˆžã„ã‚’å­¦ã¹ã‚‹ã€‚\n\nç›®æ¨™ã¯100å¹´ç¶šã‘ã¦ã€çµ¦æ–™ã®100%ã‚’å¯„ä»˜ã—ãªãŒã‚‰ã‚‚ç”Ÿãã¦ã„ã‘ã‚‹çŠ¶æ…‹ã‚’ä½œã‚‹ã“ã¨ï¼`;
  }

  // Countries
  if (lowerMessage.match(/å›½|ã‚¨ã‚¹ãƒˆãƒ‹ã‚¢|ãƒ«ãƒ¯ãƒ³ãƒ€|ã‚¦ãƒ«ã‚°ã‚¢ã‚¤|country|estonia|rwanda|uruguay/)) {
    return `UCã¯ä¸–ç•Œä¸­ã‚’æ—…ã—ã¦ã€è¤‡æ•°ã®å›½ã§ç”Ÿæ´»ã—ã¦ã„ã¾ã™ï¼\n\nðŸŒ **è¨ªå•å›½æ•°**\n34ã‚«å›½\n\nðŸ  **å±…ä½çµŒé¨“ã®ã‚ã‚‹å›½**\n- æ—¥æœ¬\n- ã‚¨ã‚¹ãƒˆãƒ‹ã‚¢ï¼ˆ2018-ï¼‰\n- ãƒ«ãƒ¯ãƒ³ãƒ€ï¼ˆ2019-ï¼‰\n- ã‚¦ãƒ«ã‚°ã‚¢ã‚¤ï¼ˆ2023ï¼‰\n- ç¾åœ¨ã¯å±±æ¢¨çœŒã«å®šä½\n\nðŸŽ¯ **å›½é¸ã³ã®åŸºæº–**\n- å®‰å…¨ã§ã‚ã‚‹ã“ã¨\n- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆç’°å¢ƒãŒè‰¯ã„ã“ã¨\n- æ—¥æœ¬äººãŒå°‘ãªã„ã“ã¨ï¼ˆå…¨åœŸã§100äººç¨‹åº¦ã¾ã§ï¼‰\n\nâœˆï¸ **ä»Šå¾Œã®ç›®æ¨™**\nå…¨å¤§é™¸åˆ¶è¦‡ï¼ï¼ˆå—æ¥µä»¥å¤–ã®å…¨å¤§é™¸ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç”Ÿã¿å‡ºã™ï¼‰`;
  }

  // Contact
  if (lowerMessage.match(/é€£çµ¡|ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ|contact|ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸|message/)) {
    return `UCã¸ã®é€£çµ¡æ–¹æ³•ï¼š\n\nðŸ’Œ **UCã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**\nã€Œæœ¬ã‚’èª­ã‚“ã ã‚‰ã™ãDMãã ã•ã„ï¼ã€\n\nUCã¯æœ¬ã‚’èª­ã‚“ã ã‚‰è‘—è€…ã«DMã‚’é€ã‚‹ç¿’æ…£ãŒã‚ã‚Šã€åŒã˜ã‚ˆã†ã«é€£çµ¡ã‚’ã‚‚ã‚‰ãˆãŸã‚‰å¬‰ã—ã„ãã†ã§ã™ã€‚\n\nðŸŒ **SNS**\nInstagramã€Xï¼ˆTwitterï¼‰ã€Facebookã€TikTokã€LinkedInã§æ´»å‹•ä¸­\n\nðŸ“§ **ã“ã®ã‚µã‚¤ãƒˆã‹ã‚‰**\nã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ãŠå•ã„åˆã‚ã›ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚‚é€£çµ¡ã§ãã¾ã™ï¼\n\nã¨ã‚Šã‚ãˆãšé€£çµ¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼`;
  }

  // Default response
  return `ã™ã¿ã¾ã›ã‚“ã€ãã®è³ªå•ã«ã¯ã†ã¾ãç­”ãˆã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n\nUCã«ã¤ã„ã¦ã€ã“ã‚“ãªã“ã¨ã‚’èžã„ã¦ã¿ã¦ãã ã•ã„ï¼š\n\nðŸ‘¤ UCã£ã¦èª°ï¼Ÿ\nðŸ¢ ã©ã‚“ãªä¼šç¤¾ã‚’çµŒå–¶ã—ã¦ã‚‹ï¼Ÿ\nðŸƒ ã‚µãƒãƒ©ãƒžãƒ©ã‚½ãƒ³ã«ã¤ã„ã¦\nðŸ’­ ã€Œã¨ã‚Šã‚ãˆãšã€ç²¾ç¥žã£ã¦ï¼Ÿ\nâ° ã‚¿ã‚¤ãƒ ã‚«ãƒ—ã‚»ãƒ«ã«ã¤ã„ã¦\nðŸŽ‰ ä¾‹ã®ãƒ—ãƒ¼ãƒ«ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã£ã¦ï¼Ÿ\nðŸ’° UCå°‘é¡å¥¨å­¦é‡‘ã«ã¤ã„ã¦\nðŸ‘¨â€ðŸ‘©â€ðŸ‘¦ å®¶æ—ã«ã¤ã„ã¦\nðŸŒ ã©ã‚“ãªå›½ã«ä½ã‚“ã ï¼Ÿ\n\nä»–ã«ã‚‚ä½•ã§ã‚‚èžã„ã¦ãã ã•ã„ï¼`;
}

// API endpoint for chat
app.post('/api/chat', async (req, res) => {
  try {
    const { message, history = [] } = req.body;

    if (!message) {
      return res.status(400).json({ error: 'Message is required' });
    }

    const response = await getChatResponse(message, history);

    res.json({
      response,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error in /api/chat:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    knowledgeBaseLoaded: !!knowledgeBase,
    hasAnthropicKey: !!process.env.ANTHROPIC_API_KEY
  });
});

// Serve knowledge base (optional, for debugging)
app.get('/api/knowledge', (req, res) => {
  res.json(knowledgeBase);
});

// Start server
app.listen(PORT, () => {
  console.log(`âœ… UC Chatbot Server running on http://localhost:${PORT}`);
  console.log(`ðŸ“š Knowledge base: ${knowledgeBase ? 'Loaded' : 'Not loaded'}`);
  console.log(`ðŸ”‘ Anthropic API: ${process.env.ANTHROPIC_API_KEY ? 'Configured' : 'Not configured (using fallback)'}`);
});
