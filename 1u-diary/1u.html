<div id="kids-diary-recorder" style="max-width:520px;margin:20px auto;padding:16px;border:1px solid #ddd;border-radius:12px;">
  <h3 style="margin:0 0 12px;">ã„ã¡ã‚†ã†æ—¥è¨˜ ãƒ¬ã‚³ãƒ¼ãƒ€ãƒ¼</h3>

  <button id="btnToggle" style="padding:12px 18px;border-radius:10px;">
    ğŸ™ï¸ éŒ²éŸ³é–‹å§‹
  </button>

  <div id="status" style="margin-top:12px;color:#555;">æº–å‚™OKï¼ˆHTTPSå¿…é ˆï¼‰</div>
  <audio id="preview" controls style="width:100%;margin-top:8px;display:none;"></audio>
  <div id="result" style="margin-top:8px;"></div>
</div>

<script>
(() => {
  const btnToggle = document.getElementById('btnToggle');
  const statusEl  = document.getElementById('status');
  const audioEl   = document.getElementById('preview');
  const resultEl  = document.getElementById('result');

  // â† n8nã®Production URLã«ç½®ãæ›ãˆ
  const WEBHOOK_URL = 'YOUR_N8N_WEBHOOK_URL';

  let mediaRecorder, chunks = [], stream, recording = false, mimeType, ext;

  function setStatus(t){ statusEl.textContent = t; }
  function ymdTokyo(){
    const d = new Date();
    const y = new Intl.DateTimeFormat('ja-JP',{year:'numeric', timeZone:'Asia/Tokyo'}).format(d);
    const m = new Intl.DateTimeFormat('ja-JP',{month:'2-digit', timeZone:'Asia/Tokyo'}).format(d);
    const dd= new Intl.DateTimeFormat('ja-JP',{day:'2-digit',   timeZone:'Asia/Tokyo'}).format(d);
    return `${y}/${m}/${dd}`;
  }
  function pickMimeType(){
    const candidates = ['audio/webm;codecs=opus','audio/webm','audio/mp4'];
    for (const c of candidates){
      if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(c)){
        return c;
      }
    }
    return ''; // ãƒ–ãƒ©ã‚¦ã‚¶ã«ä»»ã›ã‚‹
  }

  async function startRecording(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      chunks = [];
      mimeType = pickMimeType();
      ext = mimeType.includes('mp4') ? 'm4a' : 'webm';

      mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = onStop;

      mediaRecorder.start();
      recording = true;
      btnToggle.textContent = 'â¹ï¸ éŒ²éŸ³åœæ­¢';
      setStatus('éŒ²éŸ³ä¸­â€¦è©±ã—çµ‚ã‚ã£ãŸã‚‰ã€ŒéŒ²éŸ³åœæ­¢ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');

      // å®‰å…¨ã®ãŸã‚æœ€é•·5åˆ†ã§è‡ªå‹•åœæ­¢
      setTimeout(()=>{ if (mediaRecorder && mediaRecorder.state==='recording') stopRecording(); }, 5*60*1000);
    } catch (e) {
      console.error(e);
      setStatus('ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆHTTPSå¿…é ˆï¼‰ã€‚');
    }
  }

  function stopRecording(){
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      setStatus('å‡¦ç†ä¸­â€¦');
    }
  }

  async function onStop(){
    try {
      const blob = new Blob(chunks, { type: mimeType || 'audio/webm' });
      audioEl.src = URL.createObjectURL(blob);
      audioEl.style.display = 'block';

      setStatus('éŸ³å£°ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­â€¦');

      const fd = new FormData();
      fd.append('audio', blob, `kids-diary.${ext || 'webm'}`);
      fd.append('child_name', 'ã„ã¡ã‚†ã†');     // â† è‡ªå‹•å…¥åŠ›
      fd.append('date', ymdTokyo());           // â† Asia/Tokyoã§å½“æ—¥

      const res = await fetch(WEBHOOK_URL, { method: 'POST', body: fd });
      const data = await res.json().catch(()=> ({}));

      if (res.ok) {
        setStatus('å…¬é–‹å®Œäº†ï¼');
        resultEl.innerHTML = data.link
          ? `<a href="${data.link}" target="_blank" rel="noopener">å…¬é–‹ãƒšãƒ¼ã‚¸ã‚’é–‹ã â†’ ${data.link}</a>`
          : 'å…¬é–‹URLã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«linkãªã—ï¼‰';
      } else {
        setStatus('ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ');
        resultEl.textContent = 'è©³ç´°: ' + (data.message || res.status);
      }
    } catch (err) {
      console.error(err);
      setStatus('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      resultEl.textContent = '';
    } finally {
      try { stream && stream.getTracks().forEach(t => t.stop()); } catch {}
      recording = false;
      btnToggle.textContent = 'ğŸ™ï¸ éŒ²éŸ³é–‹å§‹';
    }
  }

  btnToggle.addEventListener('click', () => {
    if (!recording) startRecording();
    else            stopRecording();
  });

  setStatus('æº–å‚™OKï¼ˆHTTPSå¿…é ˆï¼‰');
})();
</script>
